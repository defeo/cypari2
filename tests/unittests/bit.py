# -*- coding: utf-8 -*-
# Created 09/26/2017

"""Original pari/GP test file bit :
hammingweight(15)
hammingweight(x^100 + 2*x + 1)
hammingweight([Mod(1,2), 2, Mod(0,3)])
hammingweight(Vecsmall([0,1,2,3]))
hammingweight(matid(100))
hammingweight(I)
N = 2^128+2^64+1;
[bittest(N, i) | i<-[60..70]]
{
  args = [0, 3, -3, 2^65-1, N, -N, I];
  funs = [bitand, bitnegimply, bitor, bitxor];
  for (a=1,#funs,
    my (f = funs[a]);
    print("#", f);
    for (i=1,#args,
      for (j=i,#args,
        my(u=args[i], v=args[j]);
        print([u,v,iferr(f(u,v),E,E)])
      )
    )
  );
  print("#bitneg");
  for (i=1, #args,
    my (u=args[i]);
    print(iferr([u, bitneg(u,65),bitneg(u)],E,E))
  )
}

bittest(-1,10)
bitneg(-2,64)
bitneg(1,-2)
bitneg(1,128)
"""
import unittest
from cypari2 import Pari, PariError

pari = Pari()


class TestBit(unittest.TestCase):
    def iferr(self,f, u, v):
        """        
        :param f: 
        :param u: 
        :param v: 
        :return: f result with u and v parameter or an error in string 
        """
        try:
            return f(u,v)
        except PariError as e:
            return str(e)


    def test_hammingweight(self):
        x = pari('x')
        self.assertEquals(str(pari.hammingweight(15)), '4')
        self.assertEquals(str(pari.hammingweight(x ** 100 + 2 * x + 1)), '3')
        self.assertEquals(str(pari.hammingweight([pari.Mod(1, 2), 2, pari.Mod(0, 3)])), '2')
        self.assertEquals(str(pari.hammingweight(pari.Vecsmall([0, 1, 2, 3]))), '3')
        self.assertEquals(str(pari.hammingweight(pari.matid(100))), '100')
        with self.assertRaises(PariError) as context:
            pari.hammingweight('I')
        self.assertTrue('incorrect type in hammingweight (t_COMPLEX)' in str(context.exception))

    def test_bit(self):
        N = 2 ** 128 + 2 ** 64 + 1;
        self.assertEquals(str([pari.bittest(N, i) for i in range(60, 71)]), '[0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0]')

        res = [['[0, 0, 0]',
                '[0, 3, 0]',
                '[0, -3, 0]',
                '[0, 36893488147419103231, 0]',
                '[0, 340282366920938463481821351505477763073, 0]',
                '[0, -340282366920938463481821351505477763073, 0]',
                '[0, I, forbidden bitwise and t_INT , t_COMPLEX]',
                '[3, 3, 3]',
                '[3, -3, 1]',
                '[3, 36893488147419103231, 3]',
                '[3, 340282366920938463481821351505477763073, 1]',
                '[3, -340282366920938463481821351505477763073, 3]',
                '[3, I, forbidden bitwise and t_INT , t_COMPLEX]',
                '[-3, -3, -3]',
                '[-3, 36893488147419103231, 36893488147419103229]',
                '[-3, 340282366920938463481821351505477763073, 340282366920938463481821351505477763073]',
                '[-3, -340282366920938463481821351505477763073, -340282366920938463481821351505477763075]',
                '[-3, I, forbidden bitwise and t_INT , t_COMPLEX]',
                '[36893488147419103231, 36893488147419103231, 36893488147419103231]',
                '[36893488147419103231, 340282366920938463481821351505477763073, 18446744073709551617]',
                '[36893488147419103231, -340282366920938463481821351505477763073, 18446744073709551615]',
                '[36893488147419103231, I, forbidden bitwise and t_INT , t_COMPLEX]',
                '[340282366920938463481821351505477763073, 340282366920938463481821351505477763073, '
                '340282366920938463481821351505477763073]',
                '[340282366920938463481821351505477763073, -340282366920938463481821351505477763073, 1]',
                '[340282366920938463481821351505477763073, I, forbidden bitwise and t_INT , t_COMPLEX]',
                '[-340282366920938463481821351505477763073, -340282366920938463481821351505477763073, '
                '-340282366920938463481821351505477763073]',
                '[-340282366920938463481821351505477763073, I, forbidden bitwise and t_INT , t_COMPLEX]',
                '[I, I, forbidden bitwise and t_COMPLEX , t_COMPLEX]'],
               ['[0, 0, 0]',
                '[0, 3, 0]',
                '[0, -3, 0]',
                '[0, 36893488147419103231, 0]',
                '[0, 340282366920938463481821351505477763073, 0]',
                '[0, -340282366920938463481821351505477763073, 0]',
                '[0, I, forbidden bitwise negated imply t_INT , t_COMPLEX]',
                '[3, 3, 0]',
                '[3, -3, 2]',
                '[3, 36893488147419103231, 0]',
                '[3, 340282366920938463481821351505477763073, 2]',
                '[3, -340282366920938463481821351505477763073, 0]',
                '[3, I, forbidden bitwise negated imply t_INT , t_COMPLEX]',
                '[-3, -3, 0]',
                '[-3, 36893488147419103231, -36893488147419103232]',
                '[-3, 340282366920938463481821351505477763073, -340282366920938463481821351505477763076]',
                '[-3, -340282366920938463481821351505477763073, 340282366920938463481821351505477763072]',
                '[-3, I, forbidden bitwise negated imply t_INT , t_COMPLEX]',
                '[36893488147419103231, 36893488147419103231, 0]',
                '[36893488147419103231, 340282366920938463481821351505477763073, 18446744073709551614]',
                '[36893488147419103231, -340282366920938463481821351505477763073, 18446744073709551616]',
                '[36893488147419103231, I, forbidden bitwise negated imply t_INT , t_COMPLEX]',
                '[340282366920938463481821351505477763073, 340282366920938463481821351505477763073, 0]',
                '[340282366920938463481821351505477763073, -340282366920938463481821351505477763073, '
                '340282366920938463481821351505477763072]',
                '[340282366920938463481821351505477763073, I, forbidden bitwise negated imply t_INT , '
                't_COMPLEX]',
                '[-340282366920938463481821351505477763073, -340282366920938463481821351505477763073, 0]',
                '[-340282366920938463481821351505477763073, I, forbidden bitwise negated imply t_INT , '
                't_COMPLEX]',
                '[I, I, forbidden bitwise negated imply t_COMPLEX , t_COMPLEX]'],
               ['[0, 0, 0]',
                '[0, 3, 3]',
                '[0, -3, -3]',
                '[0, 36893488147419103231, 36893488147419103231]',
                '[0, 340282366920938463481821351505477763073, 340282366920938463481821351505477763073]',
                '[0, -340282366920938463481821351505477763073, -340282366920938463481821351505477763073]',
                '[0, I, forbidden bitwise or t_INT , t_COMPLEX]',
                '[3, 3, 3]',
                '[3, -3, -1]',
                '[3, 36893488147419103231, 36893488147419103231]',
                '[3, 340282366920938463481821351505477763073, 340282366920938463481821351505477763075]',
                '[3, -340282366920938463481821351505477763073, -340282366920938463481821351505477763073]',
                '[3, I, forbidden bitwise or t_INT , t_COMPLEX]',
                '[-3, -3, -3]',
                '[-3, 36893488147419103231, -1]',
                '[-3, 340282366920938463481821351505477763073, -3]',
                '[-3, -340282366920938463481821351505477763073, -1]',
                '[-3, I, forbidden bitwise or t_INT , t_COMPLEX]',
                '[36893488147419103231, 36893488147419103231, 36893488147419103231]',
                '[36893488147419103231, 340282366920938463481821351505477763073, '
                '340282366920938463500268095579187314687]',
                '[36893488147419103231, -340282366920938463481821351505477763073, '
                '-340282366920938463463374607431768211457]',
                '[36893488147419103231, I, forbidden bitwise or t_INT , t_COMPLEX]',
                '[340282366920938463481821351505477763073, 340282366920938463481821351505477763073, '
                '340282366920938463481821351505477763073]',
                '[340282366920938463481821351505477763073, -340282366920938463481821351505477763073, -1]',
                '[340282366920938463481821351505477763073, I, forbidden bitwise or t_INT , t_COMPLEX]',
                '[-340282366920938463481821351505477763073, -340282366920938463481821351505477763073, '
                '-340282366920938463481821351505477763073]',
                '[-340282366920938463481821351505477763073, I, forbidden bitwise or t_INT , t_COMPLEX]',
                '[I, I, forbidden bitwise or t_COMPLEX , t_COMPLEX]'],
               ['[0, 0, 0]',
                '[0, 3, 3]',
                '[0, -3, -3]',
                '[0, 36893488147419103231, 36893488147419103231]',
                '[0, 340282366920938463481821351505477763073, 340282366920938463481821351505477763073]',
                '[0, -340282366920938463481821351505477763073, -340282366920938463481821351505477763073]',
                '[0, I, forbidden bitwise xor t_INT , t_COMPLEX]',
                '[3, 3, 0]',
                '[3, -3, -2]',
                '[3, 36893488147419103231, 36893488147419103228]',
                '[3, 340282366920938463481821351505477763073, 340282366920938463481821351505477763074]',
                '[3, -340282366920938463481821351505477763073, -340282366920938463481821351505477763076]',
                '[3, I, forbidden bitwise xor t_INT , t_COMPLEX]',
                '[-3, -3, 0]',
                '[-3, 36893488147419103231, -36893488147419103230]',
                '[-3, 340282366920938463481821351505477763073, -340282366920938463481821351505477763076]',
                '[-3, -340282366920938463481821351505477763073, 340282366920938463481821351505477763074]',
                '[-3, I, forbidden bitwise xor t_INT , t_COMPLEX]',
                '[36893488147419103231, 36893488147419103231, 0]',
                '[36893488147419103231, 340282366920938463481821351505477763073, '
                '340282366920938463481821351505477763070]',
                '[36893488147419103231, -340282366920938463481821351505477763073, '
                '-340282366920938463481821351505477763072]',
                '[36893488147419103231, I, forbidden bitwise xor t_INT , t_COMPLEX]',
                '[340282366920938463481821351505477763073, 340282366920938463481821351505477763073, 0]',
                '[340282366920938463481821351505477763073, -340282366920938463481821351505477763073, -2]',
                '[340282366920938463481821351505477763073, I, forbidden bitwise xor t_INT , t_COMPLEX]',
                '[-340282366920938463481821351505477763073, -340282366920938463481821351505477763073, 0]',
                '[-340282366920938463481821351505477763073, I, forbidden bitwise xor t_INT , t_COMPLEX]',
                '[I, I, forbidden bitwise xor t_COMPLEX , t_COMPLEX]']]

        args = [0, 3, -3, 2 ** 65 - 1, N, -N, pari('I')];
        funs = [pari.bitand, pari.bitnegimply, pari.bitor, pari.bitxor];

        for a in range(0, len(funs)):
            f = funs[a];
            k = 0
            for i in range(0, len(args)):
                for j in range(i, len(args)):
                    u = args[i]
                    v = args[j]
                    self.assertEquals("[%s, %s, %s]" % (u, v, self.iferr(f, u, v)), res[a][k])
                    k += 1

        pari.bittest(-1,10)

    def test_bitneg(self):

        def iferrbn(u):
            try:
                return '[%s, %s, %s]' % (u, pari.bitneg(u, 65), pari.bitneg(u))
            except PariError as e:
                return str(e)
        N = 2 ** 128 + 2 ** 64 + 1;
        args = [0, 3, -3, 2 ** 65 - 1, N, -N, pari('I')];

        res = ['[0, 36893488147419103231, -1]',
               '[3, 36893488147419103228, -4]',
               '[-3, 2, 2]',
               '[36893488147419103231, 0, -36893488147419103232]',
               '[340282366920938463481821351505477763073, 18446744073709551614, '
               '-340282366920938463481821351505477763074]',
               '[-340282366920938463481821351505477763073, 18446744073709551616, 34028236692093846348182135150547776'
               '3072]',
               'incorrect type in bitwise negation (t_COMPLEX)']

        for i in range(0, len(args)):
            u = args[i]
            self.assertEquals(str(iferrbn(u)), res[i])

        self.assertEquals(pari.bitneg(-2, 64), '1')
        with self.assertRaises(PariError) as context:
            pari.bitneg(1, -2)
        self.assertTrue('domain error in bitwise negation: exponent < -1' in str(context.exception))
        self.assertEquals(pari.bitneg(1, 128), '340282366920938463463374607431768211454')

"""**** Original expected results ****

4
3
2
3
100
  ***   at top-level: hammingweight(I)
  ***                 ^----------------
  *** hammingweight: incorrect type in hammingweight (t_COMPLEX).
[0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0]
#bitand
[0, 0, 0]
[0, 3, 0]
[0, -3, 0]
[0, 36893488147419103231, 0]
[0, 340282366920938463481821351505477763073, 0]
[0, -340282366920938463481821351505477763073, 0]
[0, I, error("forbidden bitwise and t_INT , t_COMPLEX.")]
[3, 3, 3]
[3, -3, 1]
[3, 36893488147419103231, 3]
[3, 340282366920938463481821351505477763073, 1]
[3, -340282366920938463481821351505477763073, 3]
[3, I, error("forbidden bitwise and t_INT , t_COMPLEX.")]
[-3, -3, -3]
[-3, 36893488147419103231, 36893488147419103229]
[-3, 340282366920938463481821351505477763073, 340282366920938463481821351505
477763073]
[-3, -340282366920938463481821351505477763073, -3402823669209384634818213515
05477763075]
[-3, I, error("forbidden bitwise and t_INT , t_COMPLEX.")]
[36893488147419103231, 36893488147419103231, 36893488147419103231]
[36893488147419103231, 340282366920938463481821351505477763073, 184467440737
09551617]
[36893488147419103231, -340282366920938463481821351505477763073, 18446744073
709551615]
[36893488147419103231, I, error("forbidden bitwise and t_INT , t_COMPLEX.")]
[340282366920938463481821351505477763073, 3402823669209384634818213515054777
63073, 340282366920938463481821351505477763073]
[340282366920938463481821351505477763073, -340282366920938463481821351505477
763073, 1]
[340282366920938463481821351505477763073, I, error("forbidden bitwise and t_
INT , t_COMPLEX.")]
[-340282366920938463481821351505477763073, -34028236692093846348182135150547
7763073, -340282366920938463481821351505477763073]
[-340282366920938463481821351505477763073, I, error("forbidden bitwise and t
_INT , t_COMPLEX.")]
[I, I, error("forbidden bitwise and t_COMPLEX , t_COMPLEX.")]
#bitnegimply
[0, 0, 0]
[0, 3, 0]
[0, -3, 0]
[0, 36893488147419103231, 0]
[0, 340282366920938463481821351505477763073, 0]
[0, -340282366920938463481821351505477763073, 0]
[0, I, error("forbidden bitwise negated imply t_INT , t_COMPLEX.")]
[3, 3, 0]
[3, -3, 2]
[3, 36893488147419103231, 0]
[3, 340282366920938463481821351505477763073, 2]
[3, -340282366920938463481821351505477763073, 0]
[3, I, error("forbidden bitwise negated imply t_INT , t_COMPLEX.")]
[-3, -3, 0]
[-3, 36893488147419103231, -36893488147419103232]
[-3, 340282366920938463481821351505477763073, -34028236692093846348182135150
5477763076]
[-3, -340282366920938463481821351505477763073, 34028236692093846348182135150
5477763072]
[-3, I, error("forbidden bitwise negated imply t_INT , t_COMPLEX.")]
[36893488147419103231, 36893488147419103231, 0]
[36893488147419103231, 340282366920938463481821351505477763073, 184467440737
09551614]
[36893488147419103231, -340282366920938463481821351505477763073, 18446744073
709551616]
[36893488147419103231, I, error("forbidden bitwise negated imply t_INT , t_C
OMPLEX.")]
[340282366920938463481821351505477763073, 3402823669209384634818213515054777
63073, 0]
[340282366920938463481821351505477763073, -340282366920938463481821351505477
763073, 340282366920938463481821351505477763072]
[340282366920938463481821351505477763073, I, error("forbidden bitwise negate
d imply t_INT , t_COMPLEX.")]
[-340282366920938463481821351505477763073, -34028236692093846348182135150547
7763073, 0]
[-340282366920938463481821351505477763073, I, error("forbidden bitwise negat
ed imply t_INT , t_COMPLEX.")]
[I, I, error("forbidden bitwise negated imply t_COMPLEX , t_COMPLEX.")]
#bitor
[0, 0, 0]
[0, 3, 3]
[0, -3, -3]
[0, 36893488147419103231, 36893488147419103231]
[0, 340282366920938463481821351505477763073, 3402823669209384634818213515054
77763073]
[0, -340282366920938463481821351505477763073, -34028236692093846348182135150
5477763073]
[0, I, error("forbidden bitwise or t_INT , t_COMPLEX.")]
[3, 3, 3]
[3, -3, -1]
[3, 36893488147419103231, 36893488147419103231]
[3, 340282366920938463481821351505477763073, 3402823669209384634818213515054
77763075]
[3, -340282366920938463481821351505477763073, -34028236692093846348182135150
5477763073]
[3, I, error("forbidden bitwise or t_INT , t_COMPLEX.")]
[-3, -3, -3]
[-3, 36893488147419103231, -1]
[-3, 340282366920938463481821351505477763073, -3]
[-3, -340282366920938463481821351505477763073, -1]
[-3, I, error("forbidden bitwise or t_INT , t_COMPLEX.")]
[36893488147419103231, 36893488147419103231, 36893488147419103231]
[36893488147419103231, 340282366920938463481821351505477763073, 340282366920
938463500268095579187314687]
[36893488147419103231, -340282366920938463481821351505477763073, -3402823669
20938463463374607431768211457]
[36893488147419103231, I, error("forbidden bitwise or t_INT , t_COMPLEX.")]
[340282366920938463481821351505477763073, 3402823669209384634818213515054777
63073, 340282366920938463481821351505477763073]
[340282366920938463481821351505477763073, -340282366920938463481821351505477
763073, -1]
[340282366920938463481821351505477763073, I, error("forbidden bitwise or t_I
NT , t_COMPLEX.")]
[-340282366920938463481821351505477763073, -34028236692093846348182135150547
7763073, -340282366920938463481821351505477763073]
[-340282366920938463481821351505477763073, I, error("forbidden bitwise or t_
INT , t_COMPLEX.")]
[I, I, error("forbidden bitwise or t_COMPLEX , t_COMPLEX.")]
#bitxor
[0, 0, 0]
[0, 3, 3]
[0, -3, -3]
[0, 36893488147419103231, 36893488147419103231]
[0, 340282366920938463481821351505477763073, 3402823669209384634818213515054
77763073]
[0, -340282366920938463481821351505477763073, -34028236692093846348182135150
5477763073]
[0, I, error("forbidden bitwise xor t_INT , t_COMPLEX.")]
[3, 3, 0]
[3, -3, -2]
[3, 36893488147419103231, 36893488147419103228]
[3, 340282366920938463481821351505477763073, 3402823669209384634818213515054
77763074]
[3, -340282366920938463481821351505477763073, -34028236692093846348182135150
5477763076]
[3, I, error("forbidden bitwise xor t_INT , t_COMPLEX.")]
[-3, -3, 0]
[-3, 36893488147419103231, -36893488147419103230]
[-3, 340282366920938463481821351505477763073, -34028236692093846348182135150
5477763076]
[-3, -340282366920938463481821351505477763073, 34028236692093846348182135150
5477763074]
[-3, I, error("forbidden bitwise xor t_INT , t_COMPLEX.")]
[36893488147419103231, 36893488147419103231, 0]
[36893488147419103231, 340282366920938463481821351505477763073, 340282366920
938463481821351505477763070]
[36893488147419103231, -340282366920938463481821351505477763073, -3402823669
20938463481821351505477763072]
[36893488147419103231, I, error("forbidden bitwise xor t_INT , t_COMPLEX.")]
[340282366920938463481821351505477763073, 3402823669209384634818213515054777
63073, 0]
[340282366920938463481821351505477763073, -340282366920938463481821351505477
763073, -2]
[340282366920938463481821351505477763073, I, error("forbidden bitwise xor t_
INT , t_COMPLEX.")]
[-340282366920938463481821351505477763073, -34028236692093846348182135150547
7763073, 0]
[-340282366920938463481821351505477763073, I, error("forbidden bitwise xor t
_INT , t_COMPLEX.")]
[I, I, error("forbidden bitwise xor t_COMPLEX , t_COMPLEX.")]
#bitneg
[0, 36893488147419103231, -1]
[3, 36893488147419103228, -4]
[-3, 2, 2]
[36893488147419103231, 0, -36893488147419103232]
[340282366920938463481821351505477763073, 18446744073709551614, -34028236692
0938463481821351505477763074]
[-340282366920938463481821351505477763073, 18446744073709551616, 34028236692
0938463481821351505477763072]
error("incorrect type in bitwise negation (t_COMPLEX).")
1
1
  ***   at top-level: bitneg(1,-2)
  ***                 ^------------
  *** bitneg: domain error in bitwise negation: exponent < -1
340282366920938463463374607431768211454

"""
